name: CI - Test & Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Tests
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run tests
        working-directory: ./backend
        run: npm test -- --coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
      
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ matrix.node-version }}
          path: backend/coverage/

  # Frontend Tests
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false  # Continue testing other versions even if one fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run tests with detailed output
        working-directory: ./frontend
        run: |
          npm test -- \
            --coverage \
            --watchAll=false \
            --verbose \
            --testLocationInResults \
            --json \
            --outputFile=test-results.json
        continue-on-error: true
        id: test-run
      
      - name: Display test summary
        if: always()
        working-directory: ./frontend
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results.json ]; then
            echo "✅ Tests completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
            if [ -d coverage ]; then
              cat coverage/coverage-summary.txt 2>/dev/null || echo "Coverage summary not available" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Tests failed to complete" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check coverage threshold
        if: always()
        working-directory: ./frontend
        run: |
          echo "Checking coverage thresholds..."
          npm test -- --coverage --coverageThreshold='{"global":{"branches":60,"functions":60,"lines":70,"statements":70}}' --watchAll=false || echo "Coverage threshold not met (this is a warning)"
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage-node-${{ matrix.node-version }}
          fail_ci_if_error: false
      
      - name: Archive test results and coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results-node-${{ matrix.node-version }}
          path: |
            frontend/coverage/
            frontend/test-results.json
          retention-days: 30
      
      - name: Archive failed test screenshots (if any)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-failures-node-${{ matrix.node-version }}
          path: |
            frontend/coverage/
            frontend/test-results.json
          retention-days: 7
      
      - name: Fail job if tests failed
        if: steps.test-run.outcome == 'failure'
        run: |
          echo "❌ Tests failed! Check the artifacts for details."
          exit 1

  # Frontend Build
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build production bundle
        working-directory: ./frontend
        run: npm run build
        env:
          CI: true
          REACT_APP_API_URL: ${{ secrets.API_URL || 'http://localhost:3001/api' }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 7

  # Integration Test
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Start backend server
        working-directory: ./backend
        run: |
          npm start &
          echo $! > backend.pid
          sleep 5
      
      - name: Test API health
        run: |
          curl -f http://localhost:3001/health || exit 1
      
      - name: Stop backend server
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
